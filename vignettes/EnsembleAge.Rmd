---
title: "EnsembleAge: Epigenetic Age Prediction Using Ensemble Clock Methods"
author: "Amin Haghani"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{EnsembleAge: Epigenetic Age Prediction Using Ensemble Clock Methods}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

EnsembleAge provides tools for predicting epigenetic age using various clock methods including Universal Clocks, Elastic Epigenetic clocks, static ensemble methods, and dynamic ensemble clocks. The package automatically detects your data platform and prepares the data accordingly for accurate age prediction across various tissues and species.

This package accompanies the open access publication by Haghani et al. (2025): "EnsembleAge: enhancing epigenetic age assessment with a multi‑clock framework" in GeroScience (DOI: 10.1007/s11357-025-01808-1).

## Motivation and Comparison to Existing Packages

EnsembleAge addresses several key limitations in existing epigenetic age prediction approaches:

1. **Platform Compatibility**: Unlike single-platform solutions, EnsembleAge automatically detects and handles multiple methylation array platforms (Human EPIC/450k, Mammal320k, Mammal40k).

2. **Ensemble Approach**: Rather than relying on individual clocks, EnsembleAge combines multiple validated clock methods to provide more robust age predictions.

3. **Cross-Species Support**: While most existing packages focus on human data, EnsembleAge provides comprehensive support for mammalian species with specialized clocks.

4. **Automated Preprocessing**: The package handles data orientation detection, probe mapping, and missing value imputation automatically.

5. **Bioconductor Integration**: EnsembleAge works seamlessly with standard Bioconductor data structures and workflows, accepting preprocessed methylation data from packages like `sesame` and `minfi`.

## Installation

```{r install, eval=FALSE}
# Install devtools if you haven't already
if (!requireNamespace("devtools", quietly = TRUE)) {
    install.packages("devtools")
}

# Install EnsembleAge
devtools::install_github("ahaghani/EnsembleAge")
```

## Loading the Package

```{r load_package}
library(EnsembleAge)
```

## Quick Start with Simulated Data

Let's demonstrate the package functionality with simulated methylation data:

```{r create_simulated_data}
# Create simulated mammal methylation data
set.seed(123)
n_probes <- 500  # Using subset for demonstration
n_samples <- 6

# Simulate methylation data with realistic beta values
methylation_data <- data.frame(
  CGid = paste0("cg", sprintf("%08d", sample(1:100000, n_probes))),
  matrix(rbeta(n_probes * n_samples, 2, 2), nrow = n_probes, ncol = n_samples)
)
colnames(methylation_data)[-1] <- paste0("Sample_", sprintf("%02d", 1:n_samples))

# Display first few rows
head(methylation_data[, 1:4])
```

```{r create_sample_sheet}
# Create corresponding sample sheet
sample_sheet <- data.frame(
  Basename = paste0("Sample_", sprintf("%02d", 1:n_samples)),
  Age = c(0.5, 1.2, 2.1, 0.8, 1.5, 2.8),  # Ages in years
  Female = c(1, 0, 1, 1, 0, 1),  # 1=female, 0=male
  Tissue = "Blood",
  SpeciesLatinName = "Mus musculus"
)

print(sample_sheet)
```

**That's it!** EnsembleAge automatically:

- ✅ Detects your platform (Human, Mammal40k, Mammal320k)
- ✅ Preprocesses your data correctly  
- ✅ Selects optimal clock methods
- ✅ Handles missing probes with imputation
- ✅ Generates comprehensive age predictions

## Supported Platforms

EnsembleAge **automatically detects and handles** multiple methylation array platforms:

| Platform | Probe Count | File Types | Auto-Detection |
|----------|-------------|------------|----------------|
| **Human EPIC/450k** | ~850k/450k | `.RData`, `.RDS`, `.csv` | ✅ Automatic |
| **Mammal320k** | ~320k | `.RDS`, `.csv` | ✅ Automatic |
| **Mammal40k** | ~40k | `.RDS`, `.csv` | ✅ Automatic |

## Core Functions Demonstration

Let's explore the key functions of EnsembleAge using our simulated data:

```{r detect_platform}
# EnsembleAge automatically detects the data platform
platform <- detect_platform(methylation_data)
cat("Detected platform:", platform)
```

```{r check_coverage}
# Check probe coverage for different clock families
coverage_info <- check_probe_coverage(methylation_data)
print(coverage_info)
```

```{r preprocess_data}
# Preprocess the methylation data
preprocessed <- preprocess_methylation_data(methylation_data, sample_sheet, verbose = TRUE)

# Display structure of preprocessed data
str(preprocessed, max.level = 1)
```

## Data Requirements

### Methylation Data
- **Format**: Data frame or matrix with CpG sites and sample methylation values
- **Values**: Beta values (0-1 range) representing methylation levels
- **Orientation**: Probes as rows OR columns (auto-detected and fixed)
- **File Types**: `.RDS`, `.RData`, `.csv` supported

### Sample Sheet
- **Required**: `Basename` (sample IDs), `Age` (chronological age in years)
- **Optional**: `Female` (1=female, 0=male), `Tissue`, `SpeciesLatinName`
- **Format**: CSV file or R data frame

## Clock Families Included

| Clock Family | Best For | # Clocks | Description | Reference |
|-------------|----------|----------|-------------|-----------|
| **Ensemble.Static** | General mammal aging | 2 | Main ensemble clocks for mammals | [EnsembleAge Package](https://doi.org/10.1007/s11357-025-01808-1) |
| **EnsembleAge.Dynamic** | Specialized predictions | 50+ | Individual specialized mammal clocks | [EnsembleAge Package](https://doi.org/10.1007/s11357-025-01808-1) |
| **EnsembleDualAge.Static** | Cross-species studies | 1 | Human-mouse optimized clock | [EnsembleAge Package](https://doi.org/10.1007/s11357-025-01808-1) |
| **UniClock2/3** | Universal mammals | 6 | Cross-tissue, cross-species clocks | [Universal Clocks](https://www.nature.com/articles/s43587-023-00462-6) |
| **LifespanUberClock** | Lifespan prediction | 12+ | Maximum lifespan focused clocks | [Lifespan Uber Clock](https://www.biorxiv.org/content/10.1101/2022.01.16.476530v1.full) |
| **DNAmAge*** | Development/intervention | 39 | Development, Elastic, Intervention clocks | [Original Mammalian Clocks](https://elifesciences.org/articles/75244) |

## Age Prediction Examples

### Using Individual Clock Functions

```{r individual_clocks}
# Predict using ensemble static clocks (recommended for general use)
static_results <- predict_ensemble_static(methylation_data, sample_sheet, verbose = FALSE)
head(static_results)
```

```{r dual_clocks}
# Predict using dual-species clocks (good for cross-species studies)
dual_results <- predict_ensemble_dual_static(methylation_data, sample_sheet, verbose = FALSE)
head(dual_results)
```

### Using the Master Function

```{r predict_all}
# Run all available clocks
all_results <- predict_all_clocks(methylation_data, sample_sheet, verbose = FALSE)

# Summary of results
cat("Total predictions:", nrow(all_results), "\n")
cat("Clock families used:", length(unique(all_results$clockFamily)), "\n")
cat("Individual clocks used:", length(unique(all_results$epiClock)), "\n")

# Show unique clock families
unique(all_results$clockFamily)
```

### Sample Sheet Template Creation

```{r template_demo}
# Create a sample sheet template
template_path <- tempfile(fileext = ".csv")
sample_names <- colnames(methylation_data)[-1]  # Exclude CGid column

template <- create_sample_sheet_template(
  sample_names = sample_names,
  file_path = template_path
)

print(template)
```

## Bioconductor Integration

EnsembleAge is designed to work seamlessly with the Bioconductor ecosystem, particularly with methylation data preprocessed by packages like `sesame` and `minfi`.

### Working with SummarizedExperiment Objects

```{r se_demo}
# Load SummarizedExperiment (standard Bioconductor class)
library(SummarizedExperiment)

# Create a SummarizedExperiment object (as commonly produced by sesame/minfi)
n_probes <- 200
n_samples <- 4

# Simulate beta values matrix
beta_values <- matrix(rbeta(n_probes * n_samples, 2, 2), 
                     nrow = n_probes, ncol = n_samples)
rownames(beta_values) <- paste0("cg", sprintf("%08d", sample(1:100000, n_probes)))
colnames(beta_values) <- paste0("Sample_", 1:n_samples)

# Create sample metadata (colData)
sample_metadata <- data.frame(
  Basename = paste0("Sample_", 1:n_samples),
  Age = c(0.8, 1.5, 2.2, 1.1),
  Female = c(1, 0, 1, 0),
  Tissue = "Blood",
  SpeciesLatinName = "Mus musculus"
)

# Create SummarizedExperiment object
se <- SummarizedExperiment(
  assays = list(beta = beta_values),
  colData = sample_metadata
)

# Display object structure
se
```

```{r se_prediction}
# Predict ages directly from SummarizedExperiment
se_results <- predict_age_from_se(se, verbose = FALSE)

# Display results
head(se_results)
```

### Integration with Bioconductor Workflows

```{r bioc_workflow}
# Extract methylation data from various Bioconductor objects
methylation_df <- extract_methylation_data(se, assay_name = "beta")

# This works with matrices too (common output from minfi)
matrix_data <- SummarizedExperiment::assay(se, "beta")
methylation_df2 <- extract_methylation_data(matrix_data)

# Both approaches yield the same result
identical(methylation_df, methylation_df2)
```

```{r convert_back}
# Convert results back to SummarizedExperiment for downstream analysis
se_results_converted <- results_to_se(se_results)

# Display the structure
se_results_converted

# Access predicted ages as assay data
predicted_ages <- SummarizedExperiment::assay(se_results_converted, "predicted_ages")
head(predicted_ages)
```

### Typical Bioconductor Workflow Integration

EnsembleAge fits naturally into standard Bioconductor methylation analysis workflows:

1. **Data Import**: Use `sesame` or `minfi` to import and preprocess IDAT files
2. **Quality Control**: Apply standard QC measures  
3. **Normalization**: Generate beta values using established methods
4. **Age Prediction**: Apply EnsembleAge to the preprocessed data
5. **Downstream Analysis**: Use predicted ages in SummarizedExperiment objects for further analysis

```{r workflow_example, eval=FALSE}
# Typical workflow (pseudocode)
# library(sesame)
# library(minfi)

# Step 1: Import data
# se_raw <- sesame::readIDATpair("path/to/idat/files")

# Step 2: Preprocess and get beta values  
# se_processed <- sesame::qualityMask(se_raw) %>%
#                  sesame::noobCorrection() %>%
#                  sesame::getBetas()

# Step 3: Predict ages with EnsembleAge
# age_results <- predict_age_from_se(se_processed)

# Step 4: Continue with downstream analysis
# se_final <- results_to_se(age_results, se_processed)
```

## Understanding Results

### Output Format

All prediction functions return a data frame with the following key columns:

- **`Basename`**: Sample identifier
- **`Age`**: Chronological age from sample sheet
- **`epiClock`**: Name of the specific clock used for prediction
- **`epiAge`**: Predicted epigenetic age
- **`AgeAccelation`**: Age acceleration (epiAge - Age)
- **`clockFamily`**: Clock family category
- Additional sample sheet columns (Female, Tissue, etc.)

### Analyzing Results

```{r analyze_results}
# Analyze the age predictions
if (exists("all_results") && nrow(all_results) > 0) {
  # Calculate summary statistics by clock family
  library(dplyr)
  
  summary_stats <- all_results %>%
    group_by(clockFamily) %>%
    summarise(
      n_predictions = n(),
      mean_age = round(mean(Age, na.rm = TRUE), 2),
      mean_epi_age = round(mean(epiAge, na.rm = TRUE), 2),
      mean_acceleration = round(mean(AgeAccelation, na.rm = TRUE), 3),
      .groups = 'drop'
    )
  
  print(summary_stats)
}
```

### Interpretation

- **Positive age acceleration**: Sample appears older than chronological age
- **Negative age acceleration**: Sample appears younger than chronological age  
- **Multiple clocks per sample**: Each row represents one clock's prediction for one sample

```{r plot_results, fig.height=4, fig.width=6}
# Visualize age predictions vs chronological age
if (exists("static_results") && nrow(static_results) > 0) {
  plot(static_results$Age, static_results$epiAge,
       xlab = "Chronological Age (years)",
       ylab = "Predicted Epigenetic Age (years)",
       main = "EnsembleAge Predictions",
       pch = 16, col = "blue")
  abline(0, 1, col = "red", lty = 2)  # Perfect prediction line
  legend("topleft", legend = c("Predictions", "Perfect prediction"), 
         col = c("blue", "red"), pch = c(16, NA), lty = c(NA, 2))
}
```

## Citation

If you use this package in your research, please cite:

### EnsembleAge Package
```
Haghani, A., et al. (2025). EnsembleAge: enhancing epigenetic age assessment with a multi‑clock framework. 
GeroScience. DOI: 10.1007/s11357-025-01808-1
```

### Universal Clocks
```
Lu, A.T., et al. (2023). Universal DNA methylation age across mammalian tissues. 
Nature Aging, 3(9), 1144-1166. DOI: 10.1038/s43587-023-00462-6
```

### Original Mammalian Clocks  
```
Haghani, A., et al. (2021). DNA methylation networks underlying mammalian traits. 
eLife, 10, e75244. DOI: 10.7554/eLife.75244
```

### Lifespan Uber Clock
```
Lu, A.T., et al. (2022). Universal DNA methylation clocks for mammals. 
bioRxiv. DOI: 10.1101/2022.01.16.476530
```

## License

MIT License - Free for research and commercial use.

## Support

- **Issues**: Report bugs or request features on our [GitHub issues page](https://github.com/ahaghani/EnsembleAge/issues)
- **Questions**: Contact Amin Haghani at haghani_amin@yahoo.com

## Session Information

```{r sessionInfo}
sessionInfo()
``` 